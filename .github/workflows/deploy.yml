name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Verify secrets
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          YOUTUBE_CLIENT_SECRETS: ${{ secrets.YOUTUBE_CLIENT_SECRETS }}
        run: |
          for var in SSH_HOST SSH_USER SSH_PRIVATE_KEY YOUTUBE_API_KEY YOUTUBE_CLIENT_SECRETS; do
            if [ -z "${!var}" ]; then
              echo "Error: $var is not set"
              exit 1
            fi
          done

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Подготовка директории
            sudo mkdir -p /opt/youtube-converter
            cd /opt/youtube-converter
            
            # Очистка директории перед клонированием
            sudo rm -rf * .[!.]*
            
            # Клонирование репозитория
            git clone https://github.com/GeorgyKomkov/youtube-educational-converter.git .
            
            # Создание .env файла
            cat > .env << EOF
            FLASK_SECRET_KEY='$(openssl rand -hex 32)'
            YOUTUBE_API_KEY='${{ secrets.YOUTUBE_API_KEY }}'
            FLASK_ENV=production
            MAX_WORKERS=2
            WHISPER_MODEL=tiny
            REDIS_URL=redis://redis:6379/0
            CELERY_BROKER_URL=redis://redis:6379/0
            EOF
            
            # Создание директорий и установка прав
            sudo mkdir -p videos output temp cache/models logs
            sudo chmod -R 777 videos output temp cache logs
            
            # Запуск приложения
            docker-compose up -d --build
            
            # Проверка статуса
            sleep 30
            docker-compose ps
            
      - name: Health check
        run: |
          sleep 45
          for i in {1..3}; do
            if curl -f "http://${{ secrets.SSH_HOST }}:8080/health"; then
              exit 0
            fi
            sleep 15
          done
          exit 1

      - name: Verify Prometheus
        run: |
          sleep 15
          curl -f "http://${{ secrets.SSH_HOST }}:9091/metrics" || exit 1

      - name: Verify Grafana
        run: |
          sleep 15
          curl -f "http://${{ secrets.SSH_HOST }}:3000" || exit 1