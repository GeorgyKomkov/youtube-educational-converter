name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Verify secrets
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          YOUTUBE_CLIENT_SECRETS: ${{ secrets.YOUTUBE_CLIENT_SECRETS }}
        run: |
          for var in SSH_HOST SSH_USER SSH_PRIVATE_KEY YOUTUBE_API_KEY YOUTUBE_CLIENT_SECRETS; do
            if [ -z "${!var}" ]; then
              echo "Error: $var is not set"
              exit 1
            fi
          done

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Установка vm.overcommit_memory
            echo 'vm.overcommit_memory = 1' | sudo tee -a /etc/sysctl.conf
            sudo sysctl vm.overcommit_memory=1
            
            # Деплой приложения
            cd /opt/youtube-converter
            docker-compose down
            docker system prune -af --volumes
            docker-compose up -d --build
            
            # Проверка статуса
            sleep 30
            docker-compose ps
            
      - name: Health check
        run: |
          sleep 120
          for i in {1..5}; do
            if curl -f "http://${{ secrets.SSH_HOST }}:8080/health"; then
              exit 0
            fi
            sleep 30
          done
          exit 1

      - name: Verify Prometheus
        run: |
          sleep 15
          curl -f "http://${{ secrets.SSH_HOST }}:9091/metrics" || exit 1

      - name: Verify Grafana
        run: |
          sleep 15
          curl -f "http://${{ secrets.SSH_HOST }}:3000" || exit 1